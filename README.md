## aavs_uv

Utilities for handling UV data products for AAVS.

These codes use the `UVData` class from [pyuvdata](https://pyuvdata.readthedocs.io) to convert the raw HDF5 correlator output files to science-ready data formats like UVFITS, MIRIAD, and CASA MeasurementSets.

Additionally, data can be loaded into the `Visibility` data model from [ska-sdp-datamodels](https://developer.skao.int/projects/ska-sdp-datamodels/en/latest/), which is based on [xarray](https://docs.xarray.dev/en/stable/). 

![aavsuv-overview](https://github.com/ska-sci-ops/aavs_uv/assets/713251/504127b2-5aa4-46f2-aac4-dd4df502a2d5)

Some simple calibration and imaging utilities are currently in development (intended primarily for QA).

### File conversion: command-line script

Once installed, a command-line utility, `aavs_uv`, will be available:

```
> aavs_uv -h

usage: aavs_uv [-h] -o OUTPUT_FORMAT [-c ARRAY_CONFIG] [-n TELESCOPE_NAME] infile outfile

AAVS UV file conversion utility

positional arguments:
  infile                Input filename
  outfile               Output filename

options:
  -h, --help            show this help message and exit
  -o OUTPUT_FORMAT, --output_format OUTPUT_FORMAT
                        Output file format (uvfits, miriad, ms, uvh5, sdp)
  -c ARRAY_CONFIG, --array_config ARRAY_CONFIG
                        Array configuration YAML file. If supplied, will override aavs_uv internal array configs.
  -n TELESCOPE_NAME, --telescope_name TELESCOPE_NAME
                        Telescope name, e.g. 'aavs3'. If supplied, will attempt to use aavs_uv internal array config.
```

The converter needs a [yaml configuration file](https://github.com/ska-sci-ops/aavs_uv/tree/main/example-config), which can be supplied with the `-c` argument, or internal defaults can be used instead via the `-n` argument (for '-n aavs2' and '-n aavs3'):

```
# Convert AAVS3 HDF5 data into a MeasurementSet
> aavs_uv -n aavs3 -o ms correlator_data.hdf5 my_new_measurement_set.ms
```

### File conversion: Python API

```python 

from aavs_uv.io import hdf5_to_pyuvdata, hdf5_to_sdp_vis

def hdf5_to_pyuvdata(filename: str, yaml_config: str) -> pyuvdata.UVData:
    """ Convert AAVS2/3 HDF5 correlator output to UVData object

    Args:
        filename (str): Name of file to open
        yaml_config (str): YAML configuration file with basic telescope info.
                           See README for more information
    Returns:
        uv (pyuvdata.UVData): A UVData object that can be used to create 
                              UVFITS/MIRIAD/UVH5/etc files
    """

def hdf5_to_sdp_vis(fn_raw: str, yaml_raw: str) -> Visibility:
    """ Generate a SDP Visibility object from a AAVS2 HDF5 file

    Args:
        fn_raw (str): Filename of raw HDF5 data to load.
        yaml_raw (str): YAML config data with telescope information
                        See https://github.com/ska-low/aavs_uv/tree/main/config#uv_configyaml

    Notes:
        The HDF5 files generated by AAVS2/3 are NOT the same format as that found in
        ska-sdp-datamodels HDF5 visibilty specification. 
        The AAVS DAQ receiver code in aavs-system has some info on the HDF5 format, here: 
        https://gitlab.com/ska-telescope/aavs-system/-/blob/master/python/pydaq/persisters/corr.py
    """
```

#### Dependencies

```
pandas
h5py
astropy
pyuvdata
numpy
loguru
ska_sdp_datamodels
```